{{ define "events_page" }}
<script defer src="/static/js/events.js"></script>
<div class="w-full relative">
    <div class="
        w-[3rem] min-h-screen fixed py-10 px-2 flex flex-col items-center 
        border-r border-gray-200 z-50
    ">
        <p class="text-gray-800 text-2xl font-semibold">T</p> 

        {{ $iconBtn := "w-full aspect-square border border-gray-200 rounded-md p-1 hover:bg-gray-200 cursor-pointer" }}
        <div class="flex flex-col gap-2 w-full mt-10 text-gray-600">
            <a 
                class="{{ $iconBtn }}"
                href="/wallets"
            >
                <svg class="w-full h-full p-0.25" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a2.25 2.25 0 0 0-2.25-2.25H15a3 3 0 1 1-6 0H5.25A2.25 2.25 0 0 0 3 12m18 0v6a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 18v-6m18 0V9M3 12V9m18 0a2.25 2.25 0 0 0-2.25-2.25H5.25A2.25 2.25 0 0 0 3 9m18 0V6a2.25 2.25 0 0 0-2.25-2.25H5.25A2.25 2.25 0 0 0 3 6v3" />
                </svg>
            </a>
            <a 
                class="{{ $iconBtn }}"
                href="/events"
            >
                <svg class="w-full h-full p-0.25" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6.429 9.75 2.25 12l4.179 2.25m0-4.5 5.571 3 5.571-3m-11.142 0L2.25 7.5 12 2.25l9.75 5.25-4.179 2.25m0 0L21.75 12l-4.179 2.25m0 0 4.179 2.25L12 21.75 2.25 16.5l4.179-2.25m11.142 0-5.571 3-5.571-3" />
                </svg>
            </a>

            <div class="w-[calc(100%+1rem)] -mx-2 border-t border-gray-200"></div>

            <button class="{{ $iconBtn }} hoverable" id="btn-refetch">
                <svg class="w-full h-full p-0.25" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                </svg>
                
                <div class="floating-right">
                    Refetch
                </div>
            </button>

            <div class="{{ $iconBtn }} hoverable" id="btn-parse-txs">
                <svg class="w-full h-full p-0.25" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>

                <span class="floating-right">
                    Parse transactions and events
                </span>
            </div>

            <button class="{{ $iconBtn }} hoverable" id="btn-parse-events">
                <svg class="w-full h-full p-0.25" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>

                <span class="floating-right">
                    Parse events
                </span>
            </button>
        </div>
    </div>

    <div class="w-[calc(100%-3rem)] pt-10 ml-[3rem]">
        <header class="w-full px-4 flex items-center justify-between text-gray-800">
            <h1 class="font-semibold text-2xl">Events</h1>
            <div class="flex items-center gap-8">
                {{ template "events_progress_indicator" .ProgressIndicator }}
                <a href="{{ .NextUrl }}" class="text-gray-800 link">
                    Next
                </a>
            </div>
        </header>

        <!-- TODO -->
        <div id="table-nav-floating" class="
            py-2 px-4 fixed bottom-2 right-4 flex items-center gap-8
            bg-white border border-gray-200 rounded-lg z-1000 hidden
        ">
            {{ template "events_progress_indicator" .ProgressIndicator }}
            <a href="{{ .NextUrl }}" class="text-gray-800 link">
                Next
            </a>
        </div>

        <div id="table-container" class="w-full px-4 mt-10 overflow-x-auto">
            <div class="w-fit min-w-full relative">
                <!-- header -->
                <div id="table-header-placeholder" class="w-full h-10"></div>
                <div id="table-header" class="
                    w-full h-10 pl-4 grid grid-cols-[150px_1fr] items-center
                    absolute top-0 z-1000
                    bg-gray-50 border border-gray-200 rounded-lg text-gray-800
                ">
                    <span>Date</span>
                    <div class="w-full px-4 grid grid-cols-[300px_repeat(2,minmax(350px,1fr))_150px]">
                        <span>App</span>
                        <div class="flex">
                            <span class="w-1/2">Outgoing</span>
                            <span>Disposal</span>
                        </div>
                        <div class="flex">
                            <span class="w-1/2">Incoming</span>
                            <span>Acquisition</span>
                        </div>
                        <span>Profit</span>
                    </div>
                </div>

                <ul 
                    id="events-table"
                    class="w-fit min-w-full mt-4 flex flex-col gap-y-4"
                >
                    {{ template "events_rows" .Rows }}
                </ul>
            </div>
        </div>
    </div>
</div>
{{ end }}

{{ define "events_rows" }}
{{ range . }}
    {{ if eq .Type 0 }}
        <li class="w-full py-1 px-4 bg-crossed rounded-lg">
            <span class="text-sm text-gray-800">{{ formatDate .Timestamp }}</span>
        </li>
    {{ else }}
        <!-- Timestamp + explorer -->
        <li class="w-full pl-4 grid grid-cols-[150px_1fr] gap-y-4">
            <div class="flex flex-col col-[1/2]">
                <a
                    href="{{ .ExplorerUrl }}"
                    target="_blank"
                    class="text-gray-800 decoration-gray-400 link"
                >{{ .TxId }}</a>
                <span class="text-sm text-gray-700">{{ formatTime .Timestamp }}</span>
            </div>

            <!-- event data -->
            
            {{ if .Events }}
                {{ range .Events }}
                    <div class="
                        w-full col-[2/-1] border border-gray-200 rounded-lg
                    ">
                        {{ template "event_component" . }}
                    </div>
                {{ end }}
            {{ else }}
                <div class="
                    w-full col-[2/-1] min-h-14 relative
                    flex items-center justify-center 
                    border border-gray-200 rounded-lg text-gray-600
                ">
                    {{ template "events_network_component" .NetworkImgUrl }}

                    This transaction does not have any events	
                </div>
            {{ end }}

            {{ if .HasErrors }}
                <div class="
                    w-full col-[2/-1] grid grid-cols-[repeat(2,1fr)]
                    border border-gray-200 rounded-lg 
                ">
                    {{ template "event_error_group_component" .PreprocessErrors }}
                    {{ template "event_error_group_component" .ProcessErrors }}
                </div>
            {{ end }}
        </li>
    {{ end }}
{{ end }}
{{ end }}

{{ define "events_progress_indicator" }}
<div 
    id="progress-indicator" 
    class="flex gap-2 items-center"
    {{ if not .Done }}data-request-id="{{ .RequestId }}"{{ end }}
>
    {{ if .Done }}
        <svg class="w-5 h-5 text-green-800" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 0 1-1.043 3.296 3.745 3.745 0 0 1-3.296 1.043A3.745 3.745 0 0 1 12 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 0 1-3.296-1.043 3.745 3.745 0 0 1-1.043-3.296A3.745 3.745 0 0 1 3 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 0 1 1.043-3.296 3.746 3.746 0 0 1 3.296-1.043A3.746 3.746 0 0 1 12 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 0 1 3.296 1.043 3.746 3.746 0 0 1 1.043 3.296A3.745 3.745 0 0 1 21 12Z" />
        </svg>
        <span>All fetched</span>
    {{ else }}
        <div 
            class="
                w-5 h-5 animate-spin rounded-full 
                border-2 border-b-transparent border-gray-600 text-gray-600
            "
        ></div>
        <span>{{ .Status }}</span>
    {{ end }}
</div>
{{ end }}

{{ define "events_network_component" }}
<div class="
	w-5 h-5 p-0.5 absolute top-0 left-0 -translate-y-1/3 -translate-x-1/3
	rounded-full bg-gray-100 border border-gray-200
	overflow-hidden
">
	<img 
		src="{{ . }}" 
		class="w-full h-full"
	/>
</div>
{{ end }}

{{ define "event_component" }}
    <div class="
        w-full px-4 py-2 grid grid-cols-[300px_repeat(2,minmax(350px,1fr))_150px] relative
    ">
        {{ template "events_network_component" .NetworkImgUrl }}

        <!-- App img, network img, event type, onchain method -->
        <div class="flex">
            <div class="w-10 h-10 rounded-full bg-gray-200">
                
            </div>

            <div class="flex flex-col ml-4">
                <span class="text-gray-800 font-medium">{{ .EventType }}</span>
                <span class="text-gray-600 text-sm">{{ .Method }}</span>
            </div>
        </div>

        <!-- Outgoing -->
        {{ template "event_transfers_component" .OutgoingTransfers }}

        <!-- Incoming -->
        {{ template "event_transfers_component" .IncomingTransfers }}

        {{ if .Profits }}
            <div class="w-full flex flex-col gap-y-1">
                <div class="opacity-0 h-[1em] text-sm"></div>
                <div class="mt-1">
                    {{ range .Profits }}
                        {{ template "event_fiat_amount_component" . }}
                    {{ end }}
                </div>
            </div>
        {{ else }}
            <div class="w-full flex flex-col gap-y-1">
                <div class="opacity-0 h-[1em] text-sm"></div>
                <div class="mt-1">-</div>
            </div>
        {{ end }}
    </div>

    {{ if .MissingBalances }}
        <div class="w-full px-4 py-2 bg-red-100 rounded-b-[.45rem]">
            {{ range .MissingBalances }}
                <div class="flex items-center gap-2">
                    <span class="
                        w-4 h-4 rounded-full text-xs bg-red-700/20 text-red-700
                        flex items-center justify-center flex-shrink-0
                    ">!</span>
                    <span class="text-gray-700 text-sm flex items-center gap-2">
                        Missing balance
                        {{ template "event_token_amount_component" . }}
                    </span>
                </div>
            {{ end }}
        </div>
    {{ end }}
{{ end }}

{{ define "event_error_group_component" }}
<div class="
    w-full p-4 border-gray-200 flex flex-col
    {{ tern (.Type | eq 0) "border-r" "" }}
">
    <span class="text-gray-600 text-sm">
        {{ if eq .Type 0 }}
            Preprocess
        {{ else }}
            Process
        {{ end }}
        errors
    </span>

    {{ if .MissingAccounts | or .BalanceMismatches | or .DataMismatches }}
        <ul class="mt-2 flex flex-col gap-3">
            {{ if .MissingAccounts }}
                <li class="-mx-2 px-2 py-0.5 text-sm text-gray-800 bg-red-100 rounded-lg">
                    Missing accounts
                </li>

                {{ range .MissingAccounts }}
                    <li class="text-sm text-gray-700 flex items-center justify-between">
                        <span>{{ shorten .Account 4 4 }}</span>
                        <span>Ix: {{ .IxIdx }}</span>
                    </li>
                {{ end }}
            {{ end }}

            {{ if .BalanceMismatches }}
                <li class="
                    -mx-2 px-2 py-0.5 grid grid-cols-[20%_20%_2fr_1fr_1fr]
                    text-sm text-gray-800 bg-red-100 rounded-lg
                ">
                    <span class="col-[1/4]">Balance mismatches</span>
                    
                    <span class="text-gray-600">Local</span>
                    <span class="text-gray-600">External</span>
                </li>
                
                {{ range .BalanceMismatches }}
                    <li class="text-sm text-gray-700 grid grid-cols-[20%_20%_2fr_1fr_1fr]">
                        <span>{{ shorten .Wallet 4 4 }}</span>
                        <span>{{ shorten .Account 4 4 }}</span>
                        <span class="flex gap-2 items-center">
                            {{ template "event_token_img" .ImgUrl }}
                            {{ upper .Token }}
                        </span>
                        <span class="w-fit hoverable">
                            {{ if .LocalZero }}
                                -
                            {{ else }}
                                {{ .LocalAmount }}
                                <div class="floating">
                                    {{ .LocalAmountLong }}
                                </div>
                            {{ end }}
                        </span>
                        <span class="w-fit hoverable">
                            {{ if .ExternalZero }}
                                -
                            {{ else }}
                                {{ .ExternalAmount }}
                                <div class="floating">
                                    {{ .ExternalAmountLong }}
                                </div>
                            {{ end }}
                        </span>
                    </li>
                {{ end }}
            {{ end }}

            {{ if .DataMismatches }}
                <li class="-mx-2 px-2 py-0.5 text-sm text-gray-800 bg-red-100 rounded-lg">
                    Data mismatches
                </li>

                {{ range .DataMismatches }}
                    <li class="text-sm text-gray-700 grid grid-cols-[20%_20%_1fr_auto]">
                        <span>{{ shorten .Wallet 4 4 }}</span>
                        <span>{{ shorten .Account 4 4 }}</span>
                        <span>{{ .Message }}</span>
                        <span>Ix: {{ .IxIdx }}</span>
                    </li>
                {{ end }}
            {{ end }}
        </ul>
    {{ else }}
        <div class="w-full mt-2 text-gray-600 text-sm flex-grow flex items-center justify-center">
            No errors of this kind
        </div>
    {{ end }}
</div>
{{ end }}

{{ define "event_transfers_component" }}
<div class="w-full flex flex-col gap-y-1">
	<div class="w-full text-sm h-[1em]">
		<span class="text-gray-500 font-medium">
			{{ if . }}
                {{ .Wallet }}
			{{ end }}
		</span>
	</div>

	<div class="flex items-center mt-1">
		<!-- Token amounts -->
		<div class="w-1/2">
			{{ if and . .Tokens }}
				{{ range .Tokens }}
					{{ template "event_token_amount_component" . }}
				{{ end }}
			{{ else }}
				<div class="mt-1">-</div>
			{{ end }}
		</div>

		<!-- Fiat amounts -->
		<div>
			{{ if . }}
				{{ range .Fiats }}
					{{ template "event_fiat_amount_component" . }}
				{{ end }}
			{{ else }}
				<div class="mt-1">-</div>
			{{ end }}
		</div>
	</div>
</div>
{{ end }}

{{ define "event_token_img" }}
<div class="
    w-5 h-5 
    rounded-full overflow-hidden
">
    {{ if . }}
        <img src="{{ . }}" class="w-5 h-5 rounded-full" />
    {{ else }}
        <div class="
            w-full h-full flex items-center justify-center
            text-sm text-gray-600 bg-gray-200
        ">
            ?
        </div>
    {{ end }}
</div>
{{ end }}

{{ define "event_token_amount_component" }}
<div class="w-fit flex items-center gap-2 relative">
    {{ template "event_token_img" .ImgUrl }}

	<span
        class="text-gray-800 text-sm hoverable"
    >
        {{ .Amount }} {{ upper .Symbol }}
        <div class="flex-col floating">
            <span class="text-gray-500 text-xs font-semibold">Account</span>
            {{ shorten .Account 4 4 }}
            <span class="text-gray-500 text-xs font-semibold">Additional info</span>
            {{ .LongAmount }} {{ upper .Symbol }}
        </div>
    </span>
</div>
{{ end }}

{{ define "event_fiat_amount_component" }}
<div class="h-5 flex items-center gap-x-2 relative">
{{ if .Zero }}
	{{ if .Missing }}
		<div class="w-full flex items-center gap-x-1">
			<span class="
				w-4 h-4 rounded-full text-xs bg-red-700/20 text-red-700
				flex items-center justify-center flex-shrink-0
			">!</span>
			<span class="
				w-full px-2 py-1 text-sm text-red-800
			">Missing price</span>
		</div>
	{{ else }}
		<span class="text-gray-800 text-sm">-</span>
	{{ end }}
{{ else }}
	<span class="
		text-sm hoverable
		{{ tern (eq .Sign 0) "text-gray-800" (eq .Sign -1) "text-red-800" "text-green-800" }}
	">
        {{ .Amount }} {{ upper .Currency }}
        {{ if not .IsProfit }}
            <div class="flex-col floating">
                <span class="text-gray-500 text-xs font-semibold">Price</span>
                {{ .Price }} {{ upper .Currency }}
            </div>
        {{ end }}
    </span>
{{ end }}
</div>
{{ end }}


